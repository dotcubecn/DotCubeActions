name: Quick Reference Release
on:
  schedule:
    - cron: '0 */8 * * *' # æ¯8å°æ—¶æ‰§è¡Œä¸€æ¬¡
  push:
    branches:
      - main   # æ·»åŠ pushåˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:    # æ‰‹åŠ¨è¿è¡Œ

env: # è®¾ç½®ç¯å¢ƒå˜é‡
  TZ: Asia/Shanghai # æ—¶åŒº

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸšœ æ‹‰å–æœ€æ–°ä»£ç 
        uses: actions/checkout@v3
        with:
          ref: 'main'
          repository: 'jaywcjlove/reference'
          fetch-depth: 0

      - name: ğŸ”§ è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: â™»ï¸ ç¼–è¯‘é™æ€æ–‡ä»¶
        run: |
          CURRENT_YEAR=$(date +%Y)
          echo "REF_URL=${{ vars.REF_URL || 'http://dotcube.cc/' }}" > .env
          echo "REF_LABEL=${{ vars.REF_LABEL || 'ä¸»é¡µ' }}" >> .env
          echo "LICENSE=Â© $CURRENT_YEAR <a href=\"https://dotcube.cc/\">DotCube</a>" >> .env
          npm install
          npm run build

      - name: ğŸ“¦ æ‰“åŒ…æ„å»ºç»“æœ
        run: |
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          echo "RELEASE_NAME=$TIMESTAMP" >> $GITHUB_ENV
          tar -czf public.tar.gz -C ./dist .

      # ä¼˜å…ˆä½¿ç”¨è½¯å±æ€§æ–¹æ¡ˆ
      - name: ğŸš€ åˆ›å»ºå¸¦æ—¶é—´æˆ³çš„Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Release ${{ env.RELEASE_NAME }}"
          tag_name: "release-${{ env.RELEASE_NAME }}"
          files: public.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      # å¦‚æœå¤±è´¥åˆ™ä½¿ç”¨GitHub CLIæ–¹æ¡ˆ
      - name: ğŸš€ å¤‡é€‰æ–¹æ¡ˆ: GitHub CLIåˆ›å»ºRelease
        if: ${{ failure() }}  # ä»…åœ¨ä¸Šè¿°æ­¥éª¤å¤±è´¥æ—¶è¿è¡Œ
        run: |
          gh release create "release-${{ env.RELEASE_NAME }}" \
            --title "Release ${{ env.RELEASE_NAME }}" \
            --notes "è‡ªåŠ¨æ„å»ºçš„Quick Reference ${{ env.RELEASE_NAME }}" \
            public.tar.gz
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
