name: Quick Reference Release
on:
  schedule:
    - cron: '0 */8 * * *' # 每8小时执行一次
  push:
    branches:
      - main   # 添加push到main分支时触发
  workflow_dispatch:    # 手动运行

env: # 设置环境变量
  TZ: Asia/Shanghai # 时区

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: 🚜 拉取最新代码
        uses: actions/checkout@v3
        with:
          ref: 'main'
          repository: 'jaywcjlove/reference'
          fetch-depth: 0

      - name: 🔧 设置 Node.js 环境
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ♻️ 编译静态文件
        run: |
          # 获取当前年份
          CURRENT_YEAR=$(date +%Y)
          # 创建.env文件并写入环境变量
          echo "REF_URL=${{ vars.REF_URL || 'http://dotcube.cc/' }}" > .env
          echo "REF_LABEL=${{ vars.REF_LABEL || '主页' }}" >> .env
          echo "LICENSE=© $CURRENT_YEAR <a href=\"https://dotcube.cc/\">DotCube</a>" >> .env
          
          # 安装依赖并构建
          npm install
          npm run build

      - name: 📦 打包构建结果
        run: |
          # 创建时间戳格式: YYYYMMDD-HHMMSS
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          # 将时间戳保存为输出变量
          echo "RELEASE_NAME=$TIMESTAMP" >> $GITHUB_ENV
          
          # 打包dist目录为public.tar.gz
          tar -czf public.tar.gz -C ./dist .

      - name: 🚀 创建带时间戳的Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Release ${{ env.RELEASE_NAME }}"
          tag_name: "${{ env.RELEASE_NAME }}"
          files: public.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
